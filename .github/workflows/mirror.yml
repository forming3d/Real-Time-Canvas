name: Mirror to MONTest-source
on:
  push:
    branches: ["**"]
    tags: ["*"]
  delete: {}
  workflow_dispatch: {}
  schedule:
    - cron: "0 */6 * * *"

jobs:
  mirror:
    runs-on: ubuntu-latest
    env:
      GH_PAT: ${{ secrets.MIRROR_PAT }}        # PAT creado en MONTest-source
      SRC_OWNER: forming3d
      SRC_REPO: Real-Time-Canvas
      DEST_OWNER: MONTest-source
      DEST_REPO: Real-Time-Canvas
    steps:
      - name: Preflight token → API
        run: |
          set -euxo pipefail
          CODE=$(curl -s -o /dev/null -w "%{http_code}" \
            -H "Authorization: Bearer ${GH_PAT}" \
            https://api.github.com/repos/${DEST_OWNER}/${DEST_REPO})
          if [ "$CODE" != "200" ]; then
            echo "ERROR: La API devolvió $CODE al acceder a ${DEST_OWNER}/${DEST_REPO}."
            echo "Revisa que el PAT sea del owner '${DEST_OWNER}', tenga 'Contents: Read & write', y (si aplica) SSO autorizado."
            exit 1
          fi
      - name: Mirror all refs
        run: |
          set -euxo pipefail
          SRC="https://github.com/${SRC_OWNER}/${SRC_REPO}.git"
          DEST="https://${GH_PAT}@github.com/${DEST_OWNER}/${DEST_REPO}.git"

          echo "Clonando espejo desde ${SRC}"
          git clone --mirror "$SRC" mirror
          cd mirror

          echo "Comprobando acceso al destino con ls-remote…"
          if ! git ls-remote "$DEST" >/dev/null 2>&1; then
            echo "ERROR: Sin acceso de escritura al destino ${DEST_OWNER}/${DEST_REPO}."
            echo "1) ¿El repo destino existe y está vacío? 2) ¿PAT con Contents:RW? 3) ¿SSO autorizado?"
            exit 1
          fi

          echo "Empujando --mirror (todas las ramas y tags)…"
          git remote set-url --push origin "$DEST"
          git push --mirror
