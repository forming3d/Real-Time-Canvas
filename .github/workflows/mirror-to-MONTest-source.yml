name: Mirror to MONTest-source
on:
  push:
    branches: ["**"]
    tags: ["*"]
  delete: {}
  workflow_dispatch: {}
  schedule:
    - cron: "0 */6 * * *"

jobs:
  mirror:
    runs-on: ubuntu-latest
    steps:
      - name: Mirror all refs to MONTest-source
        env:
          GH_PAT: ${{ secrets.MIRROR_PAT }}   # PAT creado en MONTest-source
          SRC_OWNER: forming3d
          SRC_REPO: Real-Time-Canvas
          DEST_OWNER: MONTest-source
          DEST_REPO: Real-Time-Canvas
        run: |
          set -euxo pipefail

          SRC="https://github.com/${SRC_OWNER}/${SRC_REPO}.git"
          DEST="https://${GH_PAT}@github.com/${DEST_OWNER}/${DEST_REPO}.git"

          echo "Clonando espejo desde ${SRC}"
          git clone --mirror "$SRC" mirror
          cd mirror

          echo "Comprobando acceso al destino ${DEST_OWNER}/${DEST_REPO}…"
          if ! git ls-remote "$DEST" >/dev/null 2>&1; then
            echo "ERROR: No puedo acceder a ${DEST_OWNER}/${DEST_REPO} con el PAT."
            echo "Revisa: 1) que el repo existe y está vacío, 2) el PAT tiene 'Contents: Read & write',"
            echo "3) si la org requiere SSO, autoriza el token, 4) el secret MIRROR_PAT está bien pegado (sin espacios)."
            exit 1
          fi

          echo "Empujando --mirror (todas las ramas y tags)…"
          git remote set-url --push origin "$DEST"
          git push --mirror
